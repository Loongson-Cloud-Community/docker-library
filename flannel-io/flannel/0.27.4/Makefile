# This file is generated by the template.

REGISTRY?=lcr.loongnix.cn
ORGANIZATION?=flannel
REPOSITORY?=flannel
TAG?=v0.27.4
LATEST?=flase

GO_IMG?=lcr.loongnix.cn/library/golang:1.24
GOPROXY?=https://goproxy.cn,https://mirrors.aliyun.com/goproxy/,https://goproxy.io,direct

IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):$(TAG)
LATEST_IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):latest

SOURCE_URL=https://github.com/flannel-io/flannel.git
SOURCE=$(shell echo $(SOURCE_URL) | awk -F '/' '{print $$NF}' | awk -F '.' '{print $$1}')


default: image

src/$(SOURCE):
	git clone -b $(TAG) --depth=1 $(SOURCE_URL) $@

build: src/$(SOURCE)
	docker run --rm \
		-e GOARCH=loong64 \
		-e GOPROXY=$(GOPROXY) \
		-e CGO_ENABLED=0 \
		-v `pwd`/src/$(SOURCE):/v -w /v \
		$(GO_IMG) make dist/flanneld ARCH=loong64

image: build
	cp src/$(SOURCE)/dist/flanneld .
	docker build . --build-arg GO_IMG=$(GO_IMG) --build-arg RUN_IMAGE=lcr.loongnix.cn/library/alpine:3.22 -t $(IMAGE)

push:
	docker push $(IMAGE)
	@if [ $(LATEST) = "true" ]; \
		then\
		docker tag $(IMAGE) $(LATEST_IMAGE); \
		docker push $(LATEST_IMAGE); \
	fi

clean:
	rm -rf src
