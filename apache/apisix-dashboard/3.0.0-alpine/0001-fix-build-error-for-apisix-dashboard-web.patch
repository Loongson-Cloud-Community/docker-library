From 1eac29f3157b0bb8697380ad03d4e392e56ec63d Mon Sep 17 00:00:00 2001
From: Wenlong Zhang <zhangwenlong@loongson.cn>
Date: Sat, 18 Oct 2025 04:57:39 +0000
Subject: [PATCH] fix build error for apisix-dashboard web

---
 config/config.ts | 8 ++++++++
 package.json     | 4 ++--
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/config/config.ts b/config/config.ts
index 0d31eea..db290e3 100644
--- a/config/config.ts
+++ b/config/config.ts
@@ -74,4 +74,12 @@ export default defineConfig({
       },
     ],
   ],
+  chainWebpack: (config) => {
+    config.module
+      .rule('mjs$')
+      .test(/\.mjs$/)
+      .include.add(require.resolve('@monaco-editor/react')) // 仅作用于该包
+      .end()
+      .type('javascript/auto'); // Webpack 4 需手动指定为 auto 才能解析 ESM
+  },
 });
diff --git a/package.json b/package.json
index 854ae9f..81666fa 100644
--- a/package.json
+++ b/package.json
@@ -7,7 +7,7 @@
     "prepare": "cd .. && husky install web/.husky",
     "analyze": "cross-env ANALYZE=1 yarn run build",
     "copy-folder": "node --experimental-modules copy-folder.mjs",
-    "build": "yarn copy-folder monaco-editor ./public/ && NODE_OPTIONS=--max_old_space_size=4096 umi build",
+    "build": "yarn copy-folder monaco-editor ./public/ && NODE_OPTIONS=\"--openssl-legacy-provider --max_old_space_size=4096\" umi build",
     "dev": "yarn run start:dev",
     "fetch:blocks": "pro fetch-blocks --branch antd@4 && yarn run prettier",
     "i18n-remove": "pro i18n-remove --locale=zh-CN --write",
@@ -56,7 +56,7 @@
     "@ant-design/pro-table": "2.30.8",
     "@antv/x6": "^1.18.5",
     "@antv/x6-react-components": "^1.1.7",
-    "@monaco-editor/react": "^4.3.1",
+    "@monaco-editor/react": "^3.7.5",
     "@rjsf/antd": "2.2.0",
     "@rjsf/core": "2.2.0",
     "@types/js-yaml": "^4.0.0",
-- 
2.49.1

