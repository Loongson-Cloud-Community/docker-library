# This file is generated by the template.

REGISTRY ?= lcr.loongnix.cn
ORGANIZATION ?= kubernetes
REPOSITORY ?= cadvisor
TAG ?= 0.54.1

IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):$(TAG)

SOURCE_URL =https://github.com/google/cadvisor.git
SOURCE=$(shell echo $(SOURCE_URL) | awk -F '/' '{print $$NF}' | awk -F '.' '{print $$1}')

GO_IMG ?= lcr.loongnix.cn/library/golang:1.24
GOPROXY=https://goproxy.cn,https://mirrors.aliyun.com/goproxy/,https://goproxy.io,direct

default: image

src/$(SOURCE):
	git clone --depth 1 -b v$(TAG) $(SOURCE_URL)  $@

image: src/$(SOURCE)
	cp Dockerfile src/$(SOURCE)/deploy/ && \
	cd src/$(SOURCE) && \
	docker build \
		--build-arg VERSION=v$(TAG) \
		--build-arg GO_IMG=$(GO_IMG) --build-arg BASE_IMG=lcr.loongnix.cn/library/alpine:3.23 \
		-t $(IMAGE) \
		-f deploy/Dockerfile .

push:
	docker push $(IMAGE)
