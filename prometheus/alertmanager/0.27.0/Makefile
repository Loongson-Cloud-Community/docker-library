# This file is generated by the template.

REGISTRY?=lcr.loongnix.cn
ORGANIZATION?=prometheus
REPOSITORY?=alertmanager
TAG?=0.27.0
LATEST?=false

GO_IMG?=$(REGISTRY)/library/golang:1.25

IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):$(TAG)
LATEST_IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):latest

# SOURCE_URL is a url to download source, such as https://github.com/merore/merore.git.
# SOURCE is project sources, its located at src/$(SORUCE).
# PATCH is a patch that supports loong64 to $(SOURCE).
# Be sure to fill in the follows!!!
SOURCE_URL=https://github.com/prometheus/alertmanager.git
SOURCE=$(shell echo $(SOURCE_URL) | awk -F '/' '{print $$NF}' | awk -F '.' '{print $$1}')

GOPROXY ?= https://goproxy.cn,https://mirrors.aliyun.com/goproxy/,https://goproxy.io,direct
PROMU_URL  ?= https://github.com/Loongson-Cloud-Community/promu/releases/download/v0.17.0/promu-0.17.0.linux-loong64-abi2.0.tar.gz

default: image

src/$(SOURCE):
	git clone -b v$(TAG) --depth=1 $(SOURCE_URL) $@

build-%:
	docker run --rm \
		-e GOARCH=loong64 \
		-e CGO_ENABLED=0 \
		-e GOPROXY=$(GOPROXY) \
		-v `pwd`/src/$(SOURCE):/v -w /v \
		$(GO_IMG) go build \
		-a \
		-tags "netgo" \
		-ldflags "\
			-X github.com/prometheus/common/version.Version=$(TAG) \
			-X github.com/prometheus/common/version.Revision=$(TAG) \
			-X github.com/prometheus/common/version.Branch=HEAD \
			-X github.com/prometheus/common/version.BuildDate=$(shell date +%Y%m%d-%H:%M:%S)" \
		-o $* \
		./cmd/$*

asset: src/$(SOURCE)
	docker run --rm \
		-e http_proxy=$(http_proxy) \
		-e https_proxy=$(https_proxy) \
		-v `pwd`/src/$(SOURCE):/v -w /v \
		--entrypoint sh \
		$(REGISTRY)/library/node:22-slim -c 'cd ui/react-app && npm install && npm run build && cd - && scripts/compress_assets.sh'

build: asset build-amtool build-alertmanager

image: build
# Commands for building.
	cp Dockerfile src/$(SOURCE)/
	cd src/$(SOURCE)/ && \
	docker build . --build-arg BASE_IMG=$(REGISTRY)/prometheus/busybox:glibc-1.37.0 \
		 -t $(IMAGE)

push:
	docker push $(IMAGE)

clean:
	rm -rf src
