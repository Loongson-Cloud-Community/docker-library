From d7161ee76d2d81d0a26c25d4edd655c573f4144f Mon Sep 17 00:00:00 2001
From: qiangxuhui <qiangxuhui@loongson.cn>
Date: Tue, 26 Aug 2025 03:24:13 +0000
Subject: [PATCH] vmagent,vmalert: add lonng64 support

---
 app/vmagent/Makefile       |  6 ++++++
 app/vmalert/Makefile       |  3 +++
 deployment/docker/Makefile | 28 ++++++++++++++++++++++++----
 3 files changed, 33 insertions(+), 4 deletions(-)

diff --git a/app/vmagent/Makefile b/app/vmagent/Makefile
index 74c47f2df..296b9885a 100644
--- a/app/vmagent/Makefile
+++ b/app/vmagent/Makefile
@@ -21,6 +21,9 @@ vmagent-linux-arm-prod:
 vmagent-linux-arm64-prod:
 	APP_NAME=vmagent $(MAKE) app-via-docker-linux-arm64
 
+vmagent-linux-loong64-prod:
+	APP_NAME=vmagent $(MAKE) app-via-docker-linux-loong64
+
 vmagent-linux-ppc64le-prod:
 	APP_NAME=vmagent $(MAKE) app-via-docker-linux-ppc64le
 
@@ -60,6 +63,9 @@ package-vmagent-arm64:
 package-vmagent-ppc64le:
 	APP_NAME=vmagent $(MAKE) package-via-docker-ppc64le
 
+package-vmagent-loong64:
+	APP_NAME=vmagent $(MAKE) package-via-docker-loong64
+
 package-vmagent-386:
 	APP_NAME=vmagent $(MAKE) package-via-docker-386
 
diff --git a/app/vmalert/Makefile b/app/vmalert/Makefile
index 9f200f0c2..1bdb69ecf 100644
--- a/app/vmalert/Makefile
+++ b/app/vmalert/Makefile
@@ -24,6 +24,9 @@ vmalert-linux-arm64-prod:
 vmalert-linux-ppc64le-prod:
 	APP_NAME=vmalert $(MAKE) app-via-docker-linux-ppc64le
 
+vmalert-linux-loong64-prod:
+	APP_NAME=vmalert $(MAKE) app-via-docker-linux-loong64
+
 vmalert-linux-386-prod:
 	APP_NAME=vmalert $(MAKE) app-via-docker-linux-386
 
diff --git a/deployment/docker/Makefile b/deployment/docker/Makefile
index 59dcc5292..43f96455b 100644
--- a/deployment/docker/Makefile
+++ b/deployment/docker/Makefile
@@ -1,11 +1,11 @@
 # All these commands must run from repository root.
 
-DOCKER_NAMESPACE ?= victoriametrics
+DOCKER_NAMESPACE ?= lcr.loongnix.cn/victoriametrics
 
-ROOT_IMAGE ?= alpine:3.18.4
-CERTS_IMAGE := alpine:3.18.4
+ROOT_IMAGE ?= lcr.loongnix.cn/library/alpine:3.21
+CERTS_IMAGE := lcr.loongnix.cn/library/alpine:3.21
 
-GO_BUILDER_IMAGE := golang:1.21.4-alpine
+GO_BUILDER_IMAGE := lcr.loongnix.cn/library/golang:1.21-alpine
 BUILDER_IMAGE := local/builder:2.0.0-$(shell echo $(GO_BUILDER_IMAGE) | tr :/ __)-1
 BASE_IMAGE := local/base:1.1.4-$(shell echo $(ROOT_IMAGE) | tr :/ __)-$(shell echo $(CERTS_IMAGE) | tr :/ __)
 DOCKER ?= docker
@@ -37,6 +37,8 @@ app-via-docker: package-builder
 		-w /VictoriaMetrics \
 		--mount type=bind,src="$(shell pwd)/gocache-for-docker",dst=/gocache \
 		--env GOCACHE=/gocache \
+		--env https_proxy=$(https_proxy) \
+		--env http_proxy=$(http_proxy) \
 		$(DOCKER_OPTS) \
 		$(BUILDER_IMAGE) \
 		go build $(RACE) -trimpath -buildvcs=false \
@@ -87,6 +89,18 @@ publish-via-docker: \
 		--push \
 		bin
 
+publish-via-docker-loong64:
+	$(DOCKER) build \
+        --build-arg certs_image=$(CERTS_IMAGE) \
+        --build-arg root_image=$(ROOT_IMAGE) \
+        --build-arg APP_NAME=$(APP_NAME) \
+        --build-arg TARGETARCH=loong64 \
+        --tag $(DOCKER_NAMESPACE)/$(APP_NAME):$(PKG_TAG)$(RACE) \
+        --tag $(DOCKER_NAMESPACE)/$(APP_NAME):$(LATEST_TAG)$(RACE) \
+        -f app/$(APP_NAME)/multiarch/Dockerfile \
+        bin
+
+
 run-via-docker: package-via-docker
 	$(DOCKER_RUN) -it --rm \
 		--user $(shell id -u):$(shell id -g) \
@@ -115,6 +129,9 @@ app-via-docker-linux-arm64:
 	DOCKER_OPTS='--env CGO_ENABLED=1 --env GOOS=linux --env GOARCH=arm64 --env CC=/opt/cross-builder/aarch64-linux-musl-cross/bin/aarch64-linux-musl-gcc' \
 	$(MAKE) app-via-docker
 
+app-via-docker-linux-loong64:
+	CGO_ENABLED=0 GOOS=linux GOARCH=loong64 $(MAKE) app-via-docker-goos-goarch
+
 app-via-docker-linux-ppc64le:
 	CGO_ENABLED=0 GOOS=linux GOARCH=ppc64le $(MAKE) app-via-docker-goos-goarch
 
@@ -169,6 +186,9 @@ package-via-docker-arm64:
 package-via-docker-ppc64le:
 	GOARCH=ppc64le $(MAKE) package-via-docker-goarch-nocgo
 
+package-via-docker-loong64:
+	GOARCH=loong64 $(MAKE) package-via-docker-goarch-nocgo
+
 package-via-docker-386:
 	GOARCH=386 $(MAKE) package-via-docker-goarch-nocgo
 
-- 
2.49.1

