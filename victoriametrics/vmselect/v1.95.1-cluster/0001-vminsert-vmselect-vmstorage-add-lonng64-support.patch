From 5921770dcf57ef16a4aa6bc8c0600ebf09a7d115 Mon Sep 17 00:00:00 2001
From: qiangxuhui <qiangxuhui@loongson.cn>
Date: Tue, 26 Aug 2025 07:30:49 +0000
Subject: [PATCH] vminsert,vmselect,vmstorage: add lonng64 support

---
 app/vminsert/Makefile      |  3 +++
 app/vmselect/Makefile      |  3 +++
 app/vmstorage/Makefile     |  3 +++
 deployment/docker/Makefile | 22 ++++++++++++++++++----
 4 files changed, 27 insertions(+), 4 deletions(-)

diff --git a/app/vminsert/Makefile b/app/vminsert/Makefile
index 94f95ea71..2ae1bc915 100644
--- a/app/vminsert/Makefile
+++ b/app/vminsert/Makefile
@@ -27,6 +27,9 @@ vminsert-linux-arm64-prod:
 vminsert-linux-ppc64le-prod:
 	APP_NAME=vminsert $(MAKE) app-via-docker-linux-ppc64le
 
+vminsert-linux-loong64-prod:
+	APP_NAME=vminsert $(MAKE) app-via-docker-linux-loong64
+
 vminsert-linux-386-prod:
 	APP_NAME=vminsert $(MAKE) app-via-docker-linux-386
 
diff --git a/app/vmselect/Makefile b/app/vmselect/Makefile
index ec7d45f62..49acb2012 100644
--- a/app/vmselect/Makefile
+++ b/app/vmselect/Makefile
@@ -31,6 +31,9 @@ vmselect-linux-arm64-prod:
 vmselect-linux-ppc64le-prod:
 	APP_NAME=vmselect $(MAKE) app-via-docker-linux-ppc64le
 
+vmselect-linux-loong64-prod:
+	APP_NAME=vmselect $(MAKE) app-via-docker-linux-loong64
+
 vmselect-linux-386-prod:
 	APP_NAME=vmselect $(MAKE) app-via-docker-linux-386
 
diff --git a/app/vmstorage/Makefile b/app/vmstorage/Makefile
index fdb7e06cd..db6a2bbd5 100644
--- a/app/vmstorage/Makefile
+++ b/app/vmstorage/Makefile
@@ -31,6 +31,9 @@ vmstorage-linux-arm64-prod:
 vmstorage-linux-ppc64le-prod:
 	APP_NAME=vmstorage $(MAKE) app-via-docker-linux-ppc64le
 
+vmstorage-linux-loong64-prod:
+	APP_NAME=vmstorage $(MAKE) app-via-docker-linux-loong64
+
 vmstorage-linux-386-prod:
 	APP_NAME=vmstorage $(MAKE) app-via-docker-linux-386
 
diff --git a/deployment/docker/Makefile b/deployment/docker/Makefile
index 59dcc5292..12765bf29 100644
--- a/deployment/docker/Makefile
+++ b/deployment/docker/Makefile
@@ -1,11 +1,11 @@
 # All these commands must run from repository root.
 
-DOCKER_NAMESPACE ?= victoriametrics
+DOCKER_NAMESPACE ?= lcr.loongnix.cn/victoriametrics
 
-ROOT_IMAGE ?= alpine:3.18.4
-CERTS_IMAGE := alpine:3.18.4
+ROOT_IMAGE ?= lcr.loongnix.cn/library/alpine:3.21
+CERTS_IMAGE := lcr.loongnix.cn/library/alpine:3.21
 
-GO_BUILDER_IMAGE := golang:1.21.4-alpine
+GO_BUILDER_IMAGE := lcr.loongnix.cn/library/golang:1.21-alpine
 BUILDER_IMAGE := local/builder:2.0.0-$(shell echo $(GO_BUILDER_IMAGE) | tr :/ __)-1
 BASE_IMAGE := local/base:1.1.4-$(shell echo $(ROOT_IMAGE) | tr :/ __)-$(shell echo $(CERTS_IMAGE) | tr :/ __)
 DOCKER ?= docker
@@ -87,6 +87,17 @@ publish-via-docker: \
 		--push \
 		bin
 
+publish-via-docker-loong64:
+	$(DOCKER) build \
+        --build-arg certs_image=$(CERTS_IMAGE) \
+        --build-arg root_image=$(ROOT_IMAGE) \
+        --build-arg APP_NAME=$(APP_NAME) \
+        --build-arg TARGETARCH=loong64 \
+        --tag $(DOCKER_NAMESPACE)/$(APP_NAME):$(PKG_TAG)$(RACE) \
+        --tag $(DOCKER_NAMESPACE)/$(APP_NAME):$(LATEST_TAG)$(RACE) \
+        -f app/$(APP_NAME)/multiarch/Dockerfile \
+        bin
+
 run-via-docker: package-via-docker
 	$(DOCKER_RUN) -it --rm \
 		--user $(shell id -u):$(shell id -g) \
@@ -118,6 +129,9 @@ app-via-docker-linux-arm64:
 app-via-docker-linux-ppc64le:
 	CGO_ENABLED=0 GOOS=linux GOARCH=ppc64le $(MAKE) app-via-docker-goos-goarch
 
+app-via-docker-linux-loong64:
+	CGO_ENABLED=0 GOOS=linux GOARCH=loong64 $(MAKE) app-via-docker-goos-goarch
+
 app-via-docker-linux-386:
 	CGO_ENABLED=0 GOOS=linux GOARCH=386 $(MAKE) app-via-docker-goos-goarch
 
-- 
2.49.1

