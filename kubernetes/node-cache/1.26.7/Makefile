# This file is generated by the template.

REGISTRY ?= lcr.loongnix.cn
ORGANIZATION ?= kubernetes
REPOSITORY ?= k8s-dns-node-cache
TAG ?= 1.26.7

IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):$(TAG)

SOURCE_URL =https://github.com/kubernetes/dns.git
SOURCE=$(shell echo $(SOURCE_URL) | awk -F '/' '{print $$NF}' | awk -F '.' '{print $$1}')

GO_IMG ?= $(REGISTRY)/library/golang:1.24
GOPROXY=https://goproxy.cn,https://mirrors.aliyun.com/goproxy/,https://goproxy.io,direct

default: image

src/$(SOURCE):
	git clone --depth 1 -b $(TAG) $(SOURCE_URL) $@

build: src/$(SOURCE)
	docker run --rm \
		-e GOARCH=loong64 \
		-e GOPROXY=$(GOPROXY) \
		-e CGO_ENABLED=0 \
		-v `pwd`/src/$(SOURCE):/v -w /v \
		$(GO_IMG) go build -o bin/node-cache -ldflags "-X k8s.io/dns/pkg/version.VERSION=$(TAG)" cmd/node-cache/main.go

image: src/$(SOURCE) build
	cp Dockerfile src/$(SOURCE)/.node-cache-dockerfile
	cd src/$(SOURCE) && \
	docker build \
		-t $(IMAGE) \
		--build-arg=BASE_IMG=$(REGISTRY)/kubernetes-build-image/distroless-iptables:v0.7.3 \
		. -f .node-cache-dockerfile

push:
	docker push $(IMAGE)
