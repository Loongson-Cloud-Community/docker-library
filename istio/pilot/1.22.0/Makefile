# This file is generated by the template.

REGISTRY	?=lcr.loongnix.cn
ORGANIZATION	?=istio
REPOSITORY	?=pilot
TAG		?=1.22.0
LATEST		?=true

IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):$(TAG)
LATEST_IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):latest
PATCH=0001-add-loong64-support.patch
default: image

src: clean
	git clone --depth 1 -b 1.22.0 https://github.com/istio/istio

image: src
	cd istio && ls && git apply ../$(PATCH) && \
	cp -r ../vendor . && \
	docker run -v $(PWD)/istio/pilot/1.22.0/istio:/istio  lcr.loongnix.cn/library/golang:1.24  sh -c "cd  /istio && ls && go version  && go build -mod=vendor -o ./pilot-discovery  ./pilot/cmd/pilot-discovery/main.go" && \
	docker run -v $(PWD)/istio/pilot/1.22.0/istio:/istio  lcr.loongnix.cn/library/golang:1.24  sh -c "cd  /istio && ls && go version  && go build -mod=vendor -o ./loongarch64/istioctl  ./istioctl/cmd/istioctl/main.go" && \
	docker build -t lcr.loongnix.cn/istio/distro_source:latest -f docker/Dockerfile.distro_source  . && \
	docker build -t lcr.loongnix.cn/istio/istioctl:1.22.0 --build-arg TARGETARCH=loongarch64  --build-arg ISTIO_BASE_REGISTRY=lcr.loongnix.cn/istio --build-arg BASE_VERSION=1.22.0 -f istioctl/docker/Dockerfile.istioctl . && \
	docker build -t lcr.loongnix.cn/istio/base:1.22.0 -f docker/Dockerfile.base  . && \
	docker build -t lcr.loongnix.cn/istio/distroless:1.22.0 -f docker/Dockerfile.distroless . && \
	docker build -t lcr.loongnix.cn/istio/pilot:1.22.0 --build-arg BASE_DISTRIBUTION=distroless --build-arg BASE_VERSION=1.22.0 -f pilot/docker/Dockerfile.pilot .
push:
	docker push lcr.loongnix.cn/istio/distro_source:latest
	docker push lcr.loongnix.cn/istio/base:1.22.0
	docker push lcr.loongnix.cn/istio/distroless:1.22.0
	docker push lcr.loongnix.cn/istio/pilot:1.22.0

clean:
	rm -rf istio

